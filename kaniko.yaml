apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: kaniko-cache-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
  storageClassName: local-path
---
apiVersion: v1
kind: Pod
metadata:
  name: kaniko
spec:
  volumes:
    - name: kaniko-output
      emptyDir: {}
    - name: containerd-sock
      hostPath:
        path: /run/k3s/containerd/containerd.sock
        type: Socket
    - name: docker-config
      secret:
        secretName: docker-pull-secret
        items:
          - key: .dockerconfigjson
            path: config.json
    - name: kaniko-cache
      persistentVolumeClaim:
        claimName: kaniko-cache-pvc
  initContainers:
    - name: kaniko
      image: gcr.io/kaniko-project/executor:latest
      args:
        - --context=git://github.com/winwithcherwin/oblivion.git#refs/heads/main
        - --dockerfile=Dockerfile
        - --verbosity=info
        - --tarPath=/workspace/image.tar
        - --destination=winwithcherwin.com/oblivion:latest
        - --no-push
        - --verbosity=debug
        - --cache-repo=ghcr.io/winwithcherwin/oblivion
        - --cache=true
        - --cache-dir=/build/cache
      volumeMounts:
        - name: kaniko-output
          mountPath: /workspace
        - name: kaniko-cache
          mountPath: /build
        - name: docker-config
          mountPath: /kaniko/.docker/config.json
  containers:
    - name: k3s
      image: rancher/k3s:latest
      command: ["/bin/sh", "-c", "ctr images import /kaniko/output/image.tar"]
      securityContext:
        privileged: true
      volumeMounts:
        - name: kaniko-output
          mountPath: /kaniko/output
        - name: containerd-sock
          mountPath: /run/k3s/containerd/containerd.sock
          readOnly: false

