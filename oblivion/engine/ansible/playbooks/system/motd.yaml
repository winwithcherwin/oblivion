- name: Install minimal MOTD
  hosts: all
  become: true
  gather_facts: false

  tasks:

    - name: Wipe all MOTD scripts except 00-oblivion
      shell: |
        find /etc/update-motd.d/ -type f ! -name '00-oblivion' -delete || true
      args:
        executable: /bin/bash

    - name: Remove static MOTD files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/motd
        - /etc/motd.dynamic
        - /run/motd.dynamic

    - name: Install MOTD script
      copy:
        src: files/motd/00-oblivion
        dest: /etc/update-motd.d/00-oblivion
        mode: '0755'

    - name: Disable SSH static motd
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PrintMotd'
        line: 'PrintMotd no'
        create: yes

    - name: Ensure PAM prints MOTD once
      blockinfile:
        path: /etc/pam.d/sshd
        marker: "# {mark} ANSIBLE MANAGED MOTD"
        block: |
          session optional pam_motd.so noupdate
          session optional pam_motd.so

    - name: Restart SSHD
      service:
        name: ssh
        state: restarted

