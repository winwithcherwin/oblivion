- name: Clean and install MOTD
  hosts: all
  gather_facts: no

  tasks:

    - name: Remove all MOTD scripts except 00-oblivion
      shell: |
        find /etc/update-motd.d/ ! -name '00-oblivion' -type f -exec rm -f {} +
      args:
        warn: false

    - name: Remove static MOTD files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/motd
        - /etc/motd.dynamic
        - /run/motd.dynamic

    - name: Copy custom MOTD script
      copy:
        src: files/motd/00-oblivion
        dest: /etc/update-motd.d/00-oblivion
        mode: '0755'

    - name: Ensure sshd_config disables PrintMotd
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PrintMotd'
        line: 'PrintMotd no'
        create: yes

    - name: Ensure PAM only prints run-parts MOTD once
      blockinfile:
        path: /etc/pam.d/sshd
        marker: "# {mark} ANSIBLE MANAGED MOTD"
        block: |
          session optional pam_motd.so noupdate
          session optional pam_motd.so

    - name: Restart SSH
      service:
        name: ssh
        state: restarted

