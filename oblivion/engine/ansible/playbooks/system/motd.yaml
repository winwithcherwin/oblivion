- name: Install beautiful custom MOTD
  hosts: all
  become: true
  gather_facts: no

  tasks:

    - name: Remove noisy default MOTD scripts
      file:
        path: "/etc/update-motd.d/{{ item }}"
        state: absent
      loop:
        - 00-header
        - 10-help-text
        - 50-motd-news
        - 80-livepatch
        - 91-release-upgrade
        - 98-fsck-at-reboot
        - 98-reboot-required

    - name: Remove static /etc/motd file if exists
      file:
        path: /etc/motd
        state: absent

    - name: Copy custom MOTD script
      copy:
        src: files/motd/00-oblivion
        dest: /etc/update-motd.d/00-oblivion
        mode: '0755'

    - name: Ensure sshd_config disables PrintMotd
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PrintMotd'
        line: 'PrintMotd no'
        create: yes

    - name: Ensure PAM prints MOTD on SSH login
      blockinfile:
        path: /etc/pam.d/sshd
        marker: "# {mark} ANSIBLE MANAGED MOTD"
        block: |
          session optional pam_motd.so motd=/run/motd.dynamic
          session optional pam_motd.so noupdate

    - name: Restart SSH to apply MOTD settings
      service:
        name: ssh
        state: restarted

