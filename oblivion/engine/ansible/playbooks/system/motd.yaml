- name: Fully reset and install working dynamic MOTD
  hosts: all
  gather_facts: no

  tasks:

    - name: Remove old MOTD junk (scripts, static file, etc)
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/motd
        - /etc/motd.dynamic
        - /etc/update-motd.d/00-header
        - /etc/update-motd.d/10-help-text
        - /etc/update-motd.d/50-motd-news
        - /etc/update-motd.d/80-livepatch
        - /etc/update-motd.d/91-release-upgrade
        - /etc/update-motd.d/98-fsck-at-reboot
        - /etc/update-motd.d/98-reboot-required

    - name: Create custom MOTD script
      copy:
        dest: /etc/update-motd.d/00-oblivion
        mode: '0755'
        content: |
          #!/bin/bash

          # Bail if not a terminal
          [ -t 1 ] || exit 0

          TERM=${TERM:-xterm-256color}
          export TERM

          # Info
          IP=$(hostname -I | awk '{print $1}')
          WG_IP=$(ip -4 addr show wg0 2>/dev/null | awk '/inet / {print $2}' | cut -d/ -f1)
          PEERS=$(wg show wg0 2>/dev/null | grep '^peer:' | wc -l)
          UPDATES=$(apt list --upgradable 2>/dev/null | grep -v "^Listing" | wc -l)
          [[ "$UPDATES" -eq 0 ]] && STATUS="System up to date" || STATUS="$UPDATES updates available"

          HOSTNAME=$(hostname)
          UPTIME=$(uptime -p | sed 's/up //')

          # Colors
          RESET="\033[0m"
          DIM="\033[2m"
          CYAN="\033[36m"
          PURPLE="\033[35m"

          # Banner
          BANNER="ｏｂｌｉｖｉｏｎ"
          WIDTH=$(tput cols 2>/dev/null || echo 80)
          PADDING=$(( (WIDTH - ${#BANNER}) / 2 ))

          echo ""
          printf "%*s\n" $((PADDING + ${#BANNER})) "${DIM}${PURPLE}${BANNER}${RESET}"
          echo ""

          printf "${CYAN}%-15s${RESET} %s\n" "Hostname:" "$HOSTNAME"
          printf "${CYAN}%-15s${RESET} %s\n" "Uptime:" "$UPTIME"
          printf "${CYAN}%-15s${RESET} %s\n" "IP Address:" "$IP"
          if [ -n "$WG_IP" ]; then
              printf "${CYAN}%-15s${RESET} %s\n" "WireGuard:" "$WG_IP"
              printf "${CYAN}%-15s${RESET} %s\n" "WG Peers:" "$PEERS"
          fi
          printf "${CYAN}%-15s${RESET} %s\n" "Updates:" "$STATUS"
          echo ""

    - name: Ensure sshd_config disables PrintMotd
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PrintMotd'
        line: 'PrintMotd no'

    - name: Ensure PAM prints MOTD only once
      blockinfile:
        path: /etc/pam.d/sshd
        marker: "# {mark} ANSIBLE MANAGED MOTD"
        block: |
          session optional pam_motd.so motd=/run/motd.dynamic
          session optional pam_motd.so noupdate

    - name: Restart SSH to apply changes
      service:
        name: ssh
        state: restarted

